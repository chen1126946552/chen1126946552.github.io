<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-TTPBR7L');</script>
  <!-- End Google Tag Manager -->
  <script src="https://cdn.amplitude.com/script/92be23a58f32a14b496d02c34c2cc0f5.js"></script>
  <script>window.amplitude.add(window.sessionReplay.plugin({sampleRate: 1}));window.amplitude.init('92be23a58f32a14b496d02c34c2cc0f5', {"fetchRemoteConfig":true,"autocapture":{"attribution":true,"fileDownloads":true,"formInteractions":true,"pageViews":true,"sessions":true,"elementInteractions":true,"networkTracking":true,"webVitals":true,"frustrationInteractions":true}});</script>
  <script src="https://devjs.ptengine.com/7a80pnx3.js"></script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>商品详情 - PTmeili</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/common.css">
  <style>
    /* ========================================
       商品详情页样式 - 奢华精致版
       ======================================== */
    
    .product-detail-page {
      padding: 40px 0 80px;
    }

    .product-main {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 60px;
      background-color: var(--bg-white);
      border-radius: var(--radius-lg);
      padding: 50px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 50px;
    }

    /* 图片画廊 */
    .product-gallery {
      position: sticky;
      top: 120px;
    }

    .main-image {
      width: 100%;
      aspect-ratio: 1;
      background: linear-gradient(145deg, #f8f6f3, #ebe7e0);
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 18px;
      position: relative;
    }

    .main-image img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      transition: var(--transition);
    }

    .main-image:hover img {
      transform: scale(1.05);
    }

    .thumbnail-list {
      display: flex;
      gap: 12px;
    }

    .thumbnail {
      width: 80px;
      height: 80px;
      border-radius: var(--radius-sm);
      overflow: hidden;
      cursor: pointer;
      border: 3px solid transparent;
      transition: var(--transition-fast);
      background: var(--bg-cream);
    }

    .thumbnail:hover {
      border-color: var(--border-color);
    }

    .thumbnail.active {
      border-color: var(--primary-color);
    }

    .thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* 商品信息 */
    .product-info {
      padding: 10px 0;
    }

    .product-info h1 {
      font-family: var(--font-display);
      font-size: 32px;
      color: var(--text-color);
      margin-bottom: 20px;
      line-height: 1.3;
      font-weight: 600;
    }

    .product-meta {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border-light);
    }

    .product-rating {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .product-rating .stars {
      color: var(--primary-color);
      font-size: 18px;
      letter-spacing: 2px;
    }

    .product-rating .score {
      font-weight: 700;
      color: var(--text-color);
      font-size: 16px;
    }

    .product-rating .count {
      color: var(--text-muted);
      font-size: 14px;
    }

    .product-sales {
      color: var(--text-muted);
      font-size: 14px;
    }

    .price-section {
      background: linear-gradient(135deg, var(--bg-cream), #f5f0e8);
      padding: 28px;
      border-radius: var(--radius);
      margin-bottom: 28px;
      position: relative;
      overflow: hidden;
    }

    .price-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(to bottom, var(--primary-color), var(--accent-color));
    }

    .current-price {
      font-size: 36px;
      font-weight: 700;
      color: var(--primary-color);
    }

    .original-price {
      font-size: 18px;
      color: var(--text-muted);
      text-decoration: line-through;
      margin-left: 16px;
    }

    .discount-tag {
      display: inline-block;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
      color: white;
      padding: 6px 14px;
      border-radius: var(--radius-full);
      font-size: 13px;
      font-weight: 600;
      margin-left: 16px;
      letter-spacing: 0.02em;
    }

    .product-desc {
      color: var(--text-light);
      line-height: 1.8;
      margin-bottom: 28px;
      font-size: 15px;
    }

    /* 选项 */
    .option-section {
      margin-bottom: 28px;
    }

    .option-label {
      font-weight: 600;
      margin-bottom: 14px;
      color: var(--text-color);
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .option-label span {
      color: var(--primary-color);
      font-weight: 500;
    }

    .option-list {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .option-item {
      padding: 12px 24px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition-fast);
      font-weight: 500;
      font-size: 14px;
    }

    .option-item:hover {
      border-color: var(--primary-color);
    }

    .option-item.active {
      border-color: var(--primary-color);
      background: var(--primary-light);
      color: var(--primary-hover);
    }

    .option-item.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* 数量选择 */
    .quantity-section {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 36px;
    }

    .quantity-selector {
      display: flex;
      align-items: center;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }

    .quantity-btn {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--text-color);
      transition: var(--transition-fast);
      background: var(--bg-white);
    }

    .quantity-btn:hover:not(:disabled) {
      background: var(--primary-color);
      color: white;
    }

    .quantity-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .quantity-input {
      width: 70px;
      height: 48px;
      border: none;
      border-left: 2px solid var(--border-color);
      border-right: 2px solid var(--border-color);
      text-align: center;
      font-size: 16px;
      font-weight: 600;
    }

    .quantity-input:focus {
      outline: none;
    }

    .stock-info {
      color: var(--text-muted);
      font-size: 14px;
    }

    .stock-info.low {
      color: var(--danger-color);
      font-weight: 500;
    }

    /* 操作按钮 */
    .action-buttons {
      display: flex;
      gap: 16px;
    }

    .action-buttons .btn {
      flex: 1;
      padding: 18px;
      font-size: 15px;
    }

    .btn-favorite {
      flex: 0 0 auto !important;
      width: 56px;
      padding: 18px !important;
      font-size: 20px;
    }

    .btn-favorite.active {
      background: var(--primary-light);
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    /* 商品特点 */
    .features-list {
      margin-top: 36px;
      padding-top: 28px;
      border-top: 1px solid var(--border-light);
    }

    .features-list h3 {
      font-family: var(--font-display);
      font-size: 18px;
      margin-bottom: 18px;
      color: var(--text-color);
      font-weight: 600;
    }

    .features-list ul {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .features-list li {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-light);
      font-size: 14px;
    }

    .features-list li::before {
      content: '✓';
      color: var(--success-color);
      font-weight: 700;
      font-size: 12px;
      width: 20px;
      height: 20px;
      background: rgba(74, 124, 89, 0.1);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* 详情选项卡 */
    .product-tabs {
      background-color: var(--bg-white);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      margin-bottom: 50px;
    }

    .tab-header {
      display: flex;
      border-bottom: 1px solid var(--border-light);
      background: var(--bg-cream);
    }

    .tab-btn {
      padding: 22px 36px;
      font-size: 15px;
      font-weight: 600;
      color: var(--text-light);
      position: relative;
      transition: var(--transition-fast);
      letter-spacing: 0.02em;
    }

    .tab-btn:hover {
      color: var(--primary-color);
    }

    .tab-btn.active {
      color: var(--primary-color);
      background: var(--bg-white);
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    }

    .tab-content {
      display: none;
      padding: 36px;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.4s ease-out;
    }

    /* 规格表格 */
    .specs-table {
      width: 100%;
      border-collapse: collapse;
    }

    .specs-table tr:nth-child(even) {
      background-color: var(--bg-cream);
    }

    .specs-table th,
    .specs-table td {
      padding: 18px 20px;
      text-align: left;
      border-bottom: 1px solid var(--border-light);
    }

    .specs-table th {
      width: 180px;
      color: var(--text-light);
      font-weight: 600;
      font-size: 14px;
    }

    .specs-table td {
      color: var(--text-color);
    }

    /* 评价 */
    .reviews-summary {
      display: flex;
      align-items: center;
      gap: 40px;
      padding: 28px;
      background: var(--bg-cream);
      border-radius: var(--radius);
      margin-bottom: 28px;
    }

    .reviews-score {
      text-align: center;
      padding-right: 40px;
      border-right: 1px solid var(--border-color);
    }

    .reviews-score .score {
      font-size: 52px;
      font-weight: 700;
      color: var(--primary-color);
      line-height: 1;
    }

    .reviews-score .stars {
      color: var(--primary-color);
      font-size: 18px;
      margin: 10px 0;
      letter-spacing: 2px;
    }

    .reviews-score .count {
      color: var(--text-muted);
      font-size: 14px;
    }

    .review-item {
      padding: 24px 0;
      border-bottom: 1px solid var(--border-light);
    }

    .review-item:last-child {
      border-bottom: none;
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .review-author {
      font-weight: 600;
      color: var(--text-color);
    }

    .review-date {
      color: var(--text-muted);
      font-size: 14px;
    }

    .review-rating {
      color: var(--primary-color);
      margin-bottom: 12px;
      letter-spacing: 2px;
    }

    .review-content {
      color: var(--text-light);
      line-height: 1.7;
    }

    /* 相关推荐 */
    .related-products h2 {
      font-family: var(--font-display);
      font-size: 28px;
      margin-bottom: 32px;
      font-weight: 600;
    }

    /* 响应式 */
    @media (max-width: 1100px) {
      .product-main {
        grid-template-columns: 1fr;
        gap: 40px;
        padding: 36px;
      }

      .product-gallery {
        position: static;
      }
    }

    @media (max-width: 768px) {
      .product-main {
        padding: 28px;
      }

      .product-info h1 {
        font-size: 26px;
      }

      .current-price {
        font-size: 30px;
      }

      .action-buttons {
        flex-direction: column;
      }

      .action-buttons .btn {
        flex: none;
      }

      .btn-favorite {
        width: 100% !important;
      }

      .features-list ul {
        grid-template-columns: 1fr;
      }

      .tab-header {
        overflow-x: auto;
      }

      .tab-btn {
        padding: 18px 24px;
        white-space: nowrap;
      }

      .reviews-summary {
        flex-direction: column;
        text-align: center;
      }

      .reviews-score {
        padding-right: 0;
        padding-bottom: 20px;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
      }
    }

    @media (max-width: 480px) {
      .product-detail-page {
        padding: 20px 0 60px;
      }

      .product-main {
        padding: 20px;
      }

      .price-section {
        padding: 20px;
      }

      .tab-content {
        padding: 24px;
      }

      .related-products h2 {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TTPBR7L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <!-- 头部导航 -->
  <header class="header">
    <div class="container">
      <div class="header-content">
        <a href="index.html" class="logo">PTmeili</a>
        <button class="menu-toggle" aria-label="菜单" onclick="toggleMenu()">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <nav class="nav" id="mainNav">
          <a href="index.html">首页</a>
          <a href="products.html">全部商品</a>
          <a href="cart.html" class="cart-icon">
            购物车
            <span class="cart-count" style="display: none;">0</span>
          </a>
          <a href="account.html">我的账户</a>
        </nav>
      </div>
    </div>
  </header>

  <main class="product-detail-page">
    <div class="container">
      <!-- 面包屑 -->
      <div class="breadcrumb">
        <a href="index.html">首页</a>
        <span>›</span>
        <a href="products.html">全部商品</a>
        <span>›</span>
        <a href="products.html" id="categoryLink">分类</a>
        <span>›</span>
        <span id="productName">商品名称</span>
      </div>

      <!-- 商品主信息 -->
      <div class="product-main">
        <!-- 图片画廊 -->
        <div class="product-gallery">
          <div class="main-image">
            <img id="mainImage" src="" alt="">
          </div>
          <div class="thumbnail-list" id="thumbnailList">
            <!-- 动态生成 -->
          </div>
        </div>

        <!-- 商品信息 -->
        <div class="product-info">
          <h1 id="productTitle">加载中...</h1>
          
          <div class="product-meta">
            <div class="product-rating">
              <span class="stars" id="ratingStars">★★★★★</span>
              <span class="score" id="ratingScore">5.0</span>
              <span class="count">(<span id="reviewCount">0</span>条评价)</span>
            </div>
            <div class="product-sales">
              已售 <span id="salesCount">0</span>+
            </div>
          </div>

          <div class="price-section">
            <span class="current-price" id="currentPrice">¥0.00</span>
            <span class="original-price" id="originalPrice"></span>
            <span class="discount-tag" id="discountTag" style="display: none;"></span>
          </div>

          <p class="product-desc" id="productDesc"></p>

          <!-- 颜色选择 -->
          <div class="option-section" id="colorSection" style="display: none;">
            <div class="option-label">颜色：<span id="selectedColor"></span></div>
            <div class="option-list" id="colorOptions">
              <!-- 动态生成 -->
            </div>
          </div>

          <!-- 尺码选择 -->
          <div class="option-section" id="sizeSection" style="display: none;">
            <div class="option-label">尺码：<span id="selectedSize"></span></div>
            <div class="option-list" id="sizeOptions">
              <!-- 动态生成 -->
            </div>
          </div>

          <!-- 数量选择 -->
          <div class="quantity-section">
            <div class="option-label">数量：</div>
            <div class="quantity-selector">
              <button class="quantity-btn" onclick="changeQuantity(-1)">−</button>
              <input type="number" class="quantity-input" id="quantityInput" value="1" min="1">
              <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
            </div>
            <span class="stock-info" id="stockInfo">库存充足</span>
          </div>

          <!-- 操作按钮 -->
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="addToCart()">
              加入购物车
            </button>
            <button class="btn btn-secondary" onclick="buyNow()">
              立即购买
            </button>
            <button class="btn btn-outline btn-favorite" onclick="toggleFavorite(this)">
              ♡
            </button>
          </div>

          <!-- 商品特点 -->
          <div class="features-list">
            <h3>商品特点</h3>
            <ul id="featuresList">
              <!-- 动态生成 -->
            </ul>
          </div>
        </div>
      </div>

      <!-- 详情选项卡 -->
      <div class="product-tabs">
        <div class="tab-header">
          <button class="tab-btn active" data-tab="detail">商品详情</button>
          <button class="tab-btn" data-tab="specs">规格参数</button>
          <button class="tab-btn" data-tab="reviews">用户评价</button>
        </div>

        <div class="tab-content active" id="tab-detail">
          <div id="detailContent">
            <!-- 动态生成 -->
          </div>
        </div>

        <div class="tab-content" id="tab-specs">
          <table class="specs-table" id="specsTable">
            <!-- 动态生成 -->
          </table>
        </div>

        <div class="tab-content" id="tab-reviews">
          <div class="reviews-summary">
            <div class="reviews-score">
              <div class="score" id="avgRating">5.0</div>
              <div class="stars" id="avgStars">★★★★★</div>
              <div class="count"><span id="totalReviews">0</span>条评价</div>
            </div>
          </div>
          <div id="reviewsList">
            <!-- 动态生成 -->
          </div>
        </div>
      </div>

      <!-- 相关推荐 -->
      <div class="related-products">
        <h2>相关推荐</h2>
        <div class="product-grid grid-4" id="relatedProducts">
          <!-- 动态生成 -->
        </div>
      </div>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div>
          <h3>关于我们</h3>
          <ul>
            <li><a href="#">公司简介</a></li>
            <li><a href="#">联系方式</a></li>
            <li><a href="#">招聘信息</a></li>
            <li><a href="#">新闻中心</a></li>
          </ul>
        </div>
        <div>
          <h3>客户服务</h3>
          <ul>
            <li><a href="#">帮助中心</a></li>
            <li><a href="#">配送方式</a></li>
            <li><a href="#">退换货政策</a></li>
            <li><a href="#">投诉建议</a></li>
          </ul>
        </div>
        <div>
          <h3>商家合作</h3>
          <ul>
            <li><a href="#">入驻条件</a></li>
            <li><a href="#">商家中心</a></li>
            <li><a href="#">营销中心</a></li>
            <li><a href="#">物流服务</a></li>
          </ul>
        </div>
        <div>
          <h3>关注我们</h3>
          <ul>
            <li><a href="#">微信公众号</a></li>
            <li><a href="#">微博</a></li>
            <li><a href="#">抖音</a></li>
            <li><a href="#">小红书</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        © 2024 PTmeili 版权所有 · 精致生活，从这里开始
      </div>
    </div>
  </footer>

  <script src="/js/common.js"></script>
  <script src="/js/tracking.js"></script>
  <script>
    // 移动端菜单切换
    function toggleMenu() {
      const nav = document.getElementById('mainNav');
      const toggle = document.querySelector('.menu-toggle');
      nav.classList.toggle('active');
      toggle.classList.toggle('active');
    }

    let currentProduct = null;
    let selectedColor = '';
    let selectedSize = '';
    let detailPageEnterTime = Date.now();

    function getProductId() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id') || 'SKU001';
    }

    async function init() {
      const productId = getProductId();
      const products = await Products.load();
      currentProduct = products.find(p => p.id === productId);

      if (!currentProduct) {
        showToast('商品不存在', 'error');
        setTimeout(() => window.location.href = 'products.html', 2000);
        return;
      }

      renderProduct();
      renderTabs();
      renderRelatedProducts(products);
      bindEvents();

      pushEcommerceEvent('view_item', {
        value: currentProduct.price,
        items: [formatProductItem(currentProduct)]
      });
      
      // 使用新的埋点工具
      PtTracking.trackProductView(currentProduct);
    }

    function renderProduct() {
      const p = currentProduct;

      document.title = `${p.name} - PTmeili`;

      document.getElementById('categoryLink').textContent = p.category;
      document.getElementById('categoryLink').href = `products.html?category=${p.category}`;
      document.getElementById('productName').textContent = p.name;

      document.getElementById('mainImage').src = p.images?.[0] || p.image;
      document.getElementById('mainImage').alt = p.name;

      const images = p.images || [p.image];
      document.getElementById('thumbnailList').innerHTML = images.map((img, i) => `
        <div class="thumbnail ${i === 0 ? 'active' : ''}" onclick="changeImage(${i}, '${img}')">
          <img src="${img}" alt="${p.name}">
        </div>
      `).join('');

      document.getElementById('productTitle').textContent = p.name;
      document.getElementById('ratingStars').textContent = generateStars(p.rating);
      document.getElementById('ratingScore').textContent = p.rating.toFixed(1);
      document.getElementById('reviewCount').textContent = p.reviewCount;
      document.getElementById('salesCount').textContent = Math.floor(p.reviewCount * 2.5);

      document.getElementById('currentPrice').textContent = formatPrice(p.price);
      if (p.originalPrice) {
        document.getElementById('originalPrice').textContent = formatPrice(p.originalPrice);
        const discount = Math.round((1 - p.price / p.originalPrice) * 100);
        document.getElementById('discountTag').textContent = `-${discount}%`;
        document.getElementById('discountTag').style.display = 'inline-block';
      }

      document.getElementById('productDesc').textContent = p.description;

      // 从 URL 参数读取预选的 SKU
      const urlParams = new URLSearchParams(window.location.search);
      const urlColor = urlParams.get('color');
      const urlSize = urlParams.get('size');

      if (p.colors && p.colors.length > 0) {
        document.getElementById('colorSection').style.display = 'block';
        // 优先使用 URL 参数中的颜色，否则使用第一个
        selectedColor = (urlColor && p.colors.includes(urlColor)) ? urlColor : p.colors[0];
        document.getElementById('selectedColor').textContent = selectedColor;
        document.getElementById('colorOptions').innerHTML = p.colors.map((color) => `
          <div class="option-item ${color === selectedColor ? 'active' : ''}" onclick="selectColor('${color}', this)">
            ${color}
          </div>
        `).join('');
      }

      if (p.sizes && p.sizes.length > 0) {
        document.getElementById('sizeSection').style.display = 'block';
        // 优先使用 URL 参数中的尺码，否则使用第一个
        selectedSize = (urlSize && p.sizes.includes(urlSize)) ? urlSize : p.sizes[0];
        document.getElementById('selectedSize').textContent = selectedSize;
        document.getElementById('sizeOptions').innerHTML = p.sizes.map((size) => `
          <div class="option-item ${size === selectedSize ? 'active' : ''}" onclick="selectSize('${size}', this)">
            ${size}
          </div>
        `).join('');
      }
      
      // 初始化时同步 URL 参数（确保 URL 中包含当前选中的 SKU）
      updateUrlParams();

      const stockInfo = document.getElementById('stockInfo');
      if (p.stock < 10) {
        stockInfo.textContent = `仅剩 ${p.stock} 件`;
        stockInfo.classList.add('low');
      } else {
        stockInfo.textContent = `库存充足`;
      }

      if (p.features) {
        document.getElementById('featuresList').innerHTML = p.features.map(f => `
          <li>${f}</li>
        `).join('');
      }
    }

    function renderTabs() {
      const p = currentProduct;

      document.getElementById('detailContent').innerHTML = `
        <p style="margin-bottom: 24px; line-height: 1.8; font-size: 15px; color: var(--text-light);">${p.description}</p>
        ${p.features ? `
          <h3 style="margin: 28px 0 18px; font-family: var(--font-display); font-size: 18px;">产品特点</h3>
          <ul style="line-height: 2; color: var(--text-light);">
            ${p.features.map(f => `<li style="margin-bottom: 10px; padding-left: 20px; position: relative;"><span style="position: absolute; left: 0; color: var(--primary-color);">•</span>${f}</li>`).join('')}
          </ul>
        ` : ''}
        <div style="margin-top: 36px; text-align: center;">
          <img src="${p.images?.[0] || p.image}" alt="${p.name}" style="max-width: 100%; border-radius: var(--radius);">
        </div>
      `;

      if (p.specs) {
        document.getElementById('specsTable').innerHTML = Object.entries(p.specs).map(([key, value]) => `
          <tr>
            <th>${key}</th>
            <td>${value}</td>
          </tr>
        `).join('');
      }

      document.getElementById('avgRating').textContent = p.rating.toFixed(1);
      document.getElementById('avgStars').textContent = generateStars(p.rating);
      document.getElementById('totalReviews').textContent = p.reviewCount;

      const reviews = [
        { author: '王先生', date: '2024-05-15', rating: 5, content: '非常满意这次购买，商品质量很好，物流也很快。包装精美，送人自用都很合适。' },
        { author: '李女士', date: '2024-05-10', rating: 4, content: '整体不错，性价比很高，推荐购买。客服态度也很好，有问必答。' },
        { author: '张先生', date: '2024-05-05', rating: 5, content: '用了一段时间了，确实很好用，会回购的！质量超出预期。' }
      ];

      document.getElementById('reviewsList').innerHTML = reviews.map(r => `
        <div class="review-item">
          <div class="review-header">
            <span class="review-author">${r.author}</span>
            <span class="review-date">${r.date}</span>
          </div>
          <div class="review-rating">${generateStars(r.rating)}</div>
          <p class="review-content">${r.content}</p>
        </div>
      `).join('');
    }

    function renderRelatedProducts(products) {
      const related = products
        .filter(p => p.category === currentProduct.category && p.id !== currentProduct.id)
        .slice(0, 4);

      document.getElementById('relatedProducts').innerHTML = related.map((p, index) => `
        <div class="product-card" onclick="window.location.href='product-detail.html?id=${p.id}'" style="animation-delay: ${0.1 + index * 0.1}s">
          <div class="product-image">
            ${p.isNew ? '<span class="product-badge new">新品</span>' : ''}
            ${p.isHot && !p.isNew ? '<span class="product-badge hot">热卖</span>' : ''}
            <img src="${p.image}" alt="${p.name}" loading="lazy">
          </div>
          <div class="product-info">
            <h3 class="product-title">${p.name}</h3>
            <div class="product-price">${formatPrice(p.price)}</div>
          </div>
        </div>
      `).join('');
    }

    function bindEvents() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
          
          // 埋点：Tab切换
          const tabName = btn.textContent.trim();
          PtTracking.trackTabSwitch(tabName, '商品详情');
          
          // 特殊埋点
          if (btn.dataset.tab === 'reviews') {
            PtTracking.trackViewReviews(currentProduct);
          } else if (btn.dataset.tab === 'specs') {
            PtTracking.trackViewSpecs(currentProduct);
          }
        });
      });

      document.getElementById('quantityInput').addEventListener('change', (e) => {
        let value = parseInt(e.target.value) || 1;
        value = Math.max(1, Math.min(value, currentProduct.stock));
        e.target.value = value;
      });
    }

    function changeImage(index, src) {
      document.getElementById('mainImage').src = src;
      document.querySelectorAll('.thumbnail').forEach((t, i) => {
        t.classList.toggle('active', i === index);
      });
      
      // 埋点：切换图片
      PtTracking.trackImageSwitch(currentProduct, index + 1);
    }

    function selectColor(color, el) {
      selectedColor = color;
      document.getElementById('selectedColor').textContent = color;
      document.querySelectorAll('#colorOptions .option-item').forEach(item => {
        item.classList.remove('active');
      });
      el.classList.add('active');
      
      // 更新 URL 参数
      updateUrlParams();
      
      // 埋点：选择颜色
      PtTracking.trackSelectVariant(currentProduct, '颜色', color);
    }

    function selectSize(size, el) {
      selectedSize = size;
      document.getElementById('selectedSize').textContent = size;
      document.querySelectorAll('#sizeOptions .option-item').forEach(item => {
        item.classList.remove('active');
      });
      el.classList.add('active');
      
      // 更新 URL 参数
      updateUrlParams();
      
      // 埋点：选择尺码
      PtTracking.trackSelectVariant(currentProduct, '尺码', size);
    }
    
    function updateUrlParams() {
      const url = new URL(window.location.href);
      
      // 设置颜色参数
      if (selectedColor) {
        url.searchParams.set('color', selectedColor);
      } else {
        url.searchParams.delete('color');
      }
      
      // 设置尺码参数
      if (selectedSize) {
        url.searchParams.set('size', selectedSize);
      } else {
        url.searchParams.delete('size');
      }
      
      // 使用 replaceState 更新 URL，不刷新页面也不添加历史记录
      window.history.replaceState({}, '', url.toString());
    }

    function changeQuantity(delta) {
      const input = document.getElementById('quantityInput');
      let value = parseInt(input.value) || 1;
      value = Math.max(1, Math.min(value + delta, currentProduct.stock));
      input.value = value;
    }

    function addToCart() {
      const quantity = parseInt(document.getElementById('quantityInput').value) || 1;
      const variant = {};
      
      if (selectedColor) variant.color = selectedColor;
      if (selectedSize) variant.size = selectedSize;

      Cart.addItem(currentProduct, quantity, variant);
      
      // 使用新的埋点工具
      PtTracking.trackAddToCart(currentProduct, quantity, variant);
    }

    function buyNow() {
      const quantity = parseInt(document.getElementById('quantityInput').value) || 1;
      const variant = {};
      
      if (selectedColor) variant.color = selectedColor;
      if (selectedSize) variant.size = selectedSize;
      
      pushEcommerceEvent('add_to_cart', {
        value: currentProduct.price * quantity,
        items: [formatProductItem(currentProduct, quantity)]
      });
      
      // 使用新的埋点工具
      ptengine.track('立即购买', {
        ...PtTracking.getCommonProps(),
        '商品ID': currentProduct.id,
        '商品名称': currentProduct.name,
        '商品价格': currentProduct.price,
        '购买数量': quantity,
        '小计金额': currentProduct.price * quantity,
        '颜色': selectedColor || '',
        '尺码': selectedSize || '',
        '详情页停留时间秒': Math.floor((Date.now() - detailPageEnterTime) / 1000)
      });
      
      const checkoutItem = {
        id: currentProduct.id,
        name: currentProduct.name,
        price: currentProduct.price,
        image: currentProduct.image,
        quantity: quantity,
        variant: variant
      };
      
      sessionStorage.setItem('checkoutItems', JSON.stringify([checkoutItem]));
      Cart.addItem(currentProduct, quantity, variant);
      window.location.href = 'checkout.html';
    }

    function toggleFavorite(btn) {
      btn.classList.toggle('active');
      const isActive = btn.classList.contains('active');
      btn.textContent = isActive ? '♥' : '♡';
      
      // 使用新的埋点工具
      if (isActive) {
        PtTracking.trackAddToFavorite(currentProduct);
      } else {
        PtTracking.trackRemoveFromFavorite(currentProduct);
      }
      
      showToast(isActive ? '已添加到收藏夹' : '已取消收藏');
    }

    init();
  </script>
</body>
</html>
