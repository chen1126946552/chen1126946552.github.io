<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-TTPBR7L');</script>
  <!-- End Google Tag Manager -->
  <script src="https://cdn.amplitude.com/script/92be23a58f32a14b496d02c34c2cc0f5.js"></script>
  <script>window.amplitude.add(window.sessionReplay.plugin({sampleRate: 1}));window.amplitude.init('92be23a58f32a14b496d02c34c2cc0f5', {"fetchRemoteConfig":true,"autocapture":{"attribution":true,"fileDownloads":true,"formInteractions":true,"pageViews":true,"sessions":true,"elementInteractions":true,"networkTracking":true,"webVitals":true,"frustrationInteractions":true}});</script>
  <script src="https://devjs.ptengine.com/7a80pnx3.js"></script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>商品详情 - 电商示例</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/common.css">
  <style>
    .product-detail-page {
      padding: 30px 0 60px;
    }

    .product-main {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 50px;
      background-color: var(--bg-white);
      border-radius: var(--radius);
      padding: 40px;
      box-shadow: var(--shadow);
      margin-bottom: 40px;
    }

    /* 图片画廊 */
    .product-gallery {
      position: sticky;
      top: 100px;
    }

    .main-image {
      width: 100%;
      aspect-ratio: 1;
      background-color: #f5f5f5;
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 15px;
    }

    .main-image img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .thumbnail-list {
      display: flex;
      gap: 10px;
    }

    .thumbnail {
      width: 80px;
      height: 80px;
      border-radius: var(--radius-sm);
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: var(--transition);
    }

    .thumbnail:hover {
      border-color: var(--border-color);
    }

    .thumbnail.active {
      border-color: var(--primary-color);
    }

    .thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* 商品信息 */
    .product-info h1 {
      font-size: 28px;
      color: var(--text-color);
      margin-bottom: 15px;
      line-height: 1.4;
    }

    .product-meta {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-light);
    }

    .product-rating {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .product-rating .stars {
      color: var(--warning-color);
      font-size: 18px;
    }

    .product-rating .score {
      font-weight: bold;
      color: var(--text-color);
    }

    .product-rating .count {
      color: var(--text-muted);
    }

    .product-sales {
      color: var(--text-muted);
    }

    .price-section {
      background-color: #fff5f5;
      padding: 20px;
      border-radius: var(--radius);
      margin-bottom: 25px;
    }

    .current-price {
      font-size: 32px;
      font-weight: bold;
      color: var(--primary-color);
    }

    .original-price {
      font-size: 18px;
      color: var(--text-muted);
      text-decoration: line-through;
      margin-left: 15px;
    }

    .discount-tag {
      display: inline-block;
      background-color: var(--primary-color);
      color: white;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      margin-left: 15px;
    }

    .product-desc {
      color: var(--text-light);
      line-height: 1.8;
      margin-bottom: 25px;
    }

    /* 选项 */
    .option-section {
      margin-bottom: 25px;
    }

    .option-label {
      font-weight: 500;
      margin-bottom: 12px;
      color: var(--text-color);
    }

    .option-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .option-item {
      padding: 10px 20px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition);
    }

    .option-item:hover {
      border-color: var(--primary-color);
    }

    .option-item.active {
      border-color: var(--primary-color);
      background-color: rgba(255, 107, 107, 0.1);
      color: var(--primary-color);
    }

    .option-item.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* 数量选择 */
    .quantity-section {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 30px;
    }

    .quantity-selector {
      display: flex;
      align-items: center;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
    }

    .quantity-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--text-color);
      transition: var(--transition);
    }

    .quantity-btn:hover:not(:disabled) {
      background-color: var(--bg-color);
    }

    .quantity-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .quantity-input {
      width: 60px;
      height: 40px;
      border: none;
      border-left: 1px solid var(--border-color);
      border-right: 1px solid var(--border-color);
      text-align: center;
      font-size: 16px;
    }

    .stock-info {
      color: var(--text-muted);
      font-size: 14px;
    }

    .stock-info.low {
      color: var(--primary-color);
    }

    /* 操作按钮 */
    .action-buttons {
      display: flex;
      gap: 15px;
    }

    .action-buttons .btn {
      flex: 1;
      padding: 15px;
      font-size: 16px;
    }

    .btn-favorite {
      flex: 0 0 auto;
      width: 50px;
      padding: 15px;
    }

    /* 商品特点 */
    .features-list {
      margin-top: 30px;
      padding-top: 25px;
      border-top: 1px solid var(--border-light);
    }

    .features-list h3 {
      font-size: 16px;
      margin-bottom: 15px;
      color: var(--text-color);
    }

    .features-list ul {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .features-list li {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-light);
      font-size: 14px;
    }

    .features-list li::before {
      content: '✓';
      color: var(--success-color);
      font-weight: bold;
    }

    /* 详情选项卡 */
    .product-tabs {
      background-color: var(--bg-white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      margin-bottom: 40px;
    }

    .tab-header {
      display: flex;
      border-bottom: 1px solid var(--border-light);
    }

    .tab-btn {
      padding: 18px 30px;
      font-size: 16px;
      font-weight: 500;
      color: var(--text-light);
      position: relative;
      transition: var(--transition);
    }

    .tab-btn:hover {
      color: var(--primary-color);
    }

    .tab-btn.active {
      color: var(--primary-color);
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background-color: var(--primary-color);
    }

    .tab-content {
      display: none;
      padding: 30px;
    }

    .tab-content.active {
      display: block;
    }

    /* 规格表格 */
    .specs-table {
      width: 100%;
      border-collapse: collapse;
    }

    .specs-table tr:nth-child(even) {
      background-color: var(--bg-color);
    }

    .specs-table th,
    .specs-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid var(--border-light);
    }

    .specs-table th {
      width: 150px;
      color: var(--text-light);
      font-weight: 500;
    }

    /* 评价 */
    .reviews-summary {
      display: flex;
      align-items: center;
      gap: 30px;
      padding: 20px;
      background-color: var(--bg-color);
      border-radius: var(--radius);
      margin-bottom: 25px;
    }

    .reviews-score {
      text-align: center;
    }

    .reviews-score .score {
      font-size: 48px;
      font-weight: bold;
      color: var(--primary-color);
    }

    .reviews-score .stars {
      color: var(--warning-color);
      font-size: 20px;
    }

    .reviews-score .count {
      color: var(--text-muted);
      font-size: 14px;
    }

    .review-item {
      padding: 20px 0;
      border-bottom: 1px solid var(--border-light);
    }

    .review-item:last-child {
      border-bottom: none;
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .review-author {
      font-weight: 500;
    }

    .review-date {
      color: var(--text-muted);
      font-size: 14px;
    }

    .review-rating {
      color: var(--warning-color);
      margin-bottom: 10px;
    }

    .review-content {
      color: var(--text-light);
      line-height: 1.6;
    }

    /* 相关推荐 */
    .related-products h2 {
      font-size: 24px;
      margin-bottom: 25px;
    }

    @media (max-width: 992px) {
      .product-main {
        grid-template-columns: 1fr;
        gap: 30px;
      }

      .product-gallery {
        position: static;
      }
    }

    @media (max-width: 576px) {
      .product-main {
        padding: 20px;
      }

      .product-info h1 {
        font-size: 22px;
      }

      .current-price {
        font-size: 26px;
      }

      .action-buttons {
        flex-direction: column;
      }

      .action-buttons .btn {
        flex: none;
      }

      .features-list ul {
        grid-template-columns: 1fr;
      }

      .tab-header {
        overflow-x: auto;
      }

      .tab-btn {
        padding: 15px 20px;
        white-space: nowrap;
      }
    }
  </style>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TTPBR7L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <!-- 头部导航 -->
  <header class="header">
    <div class="container">
      <div class="header-content">
        <a href="index.html" class="logo">电商示例</a>
        <button class="menu-toggle" aria-label="菜单">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <nav class="nav">
          <a href="index.html">首页</a>
          <a href="products.html">全部商品</a>
          <a href="cart.html" class="cart-icon">
            购物车
            <span class="cart-count" style="display: none;">0</span>
          </a>
          <a href="account.html">我的账户</a>
        </nav>
      </div>
    </div>
  </header>

  <main class="product-detail-page">
    <div class="container">
      <!-- 面包屑 -->
      <div class="breadcrumb">
        <a href="index.html">首页</a>
        <span>›</span>
        <a href="products.html">全部商品</a>
        <span>›</span>
        <a href="products.html" id="categoryLink">分类</a>
        <span>›</span>
        <span id="productName">商品名称</span>
      </div>

      <!-- 商品主信息 -->
      <div class="product-main">
        <!-- 图片画廊 -->
        <div class="product-gallery">
          <div class="main-image">
            <img id="mainImage" src="" alt="">
          </div>
          <div class="thumbnail-list" id="thumbnailList">
            <!-- 动态生成 -->
          </div>
        </div>

        <!-- 商品信息 -->
        <div class="product-info">
          <h1 id="productTitle">加载中...</h1>
          
          <div class="product-meta">
            <div class="product-rating">
              <span class="stars" id="ratingStars">★★★★★</span>
              <span class="score" id="ratingScore">5.0</span>
              <span class="count">(<span id="reviewCount">0</span>条评价)</span>
            </div>
            <div class="product-sales">
              已售 <span id="salesCount">0</span>+
            </div>
          </div>

          <div class="price-section">
            <span class="current-price" id="currentPrice">¥0.00</span>
            <span class="original-price" id="originalPrice"></span>
            <span class="discount-tag" id="discountTag" style="display: none;"></span>
          </div>

          <p class="product-desc" id="productDesc"></p>

          <!-- 颜色选择 -->
          <div class="option-section" id="colorSection" style="display: none;">
            <div class="option-label">颜色：<span id="selectedColor"></span></div>
            <div class="option-list" id="colorOptions">
              <!-- 动态生成 -->
            </div>
          </div>

          <!-- 尺码选择 -->
          <div class="option-section" id="sizeSection" style="display: none;">
            <div class="option-label">尺码：<span id="selectedSize"></span></div>
            <div class="option-list" id="sizeOptions">
              <!-- 动态生成 -->
            </div>
          </div>

          <!-- 数量选择 -->
          <div class="quantity-section">
            <div class="option-label">数量：</div>
            <div class="quantity-selector">
              <button class="quantity-btn" onclick="changeQuantity(-1)">−</button>
              <input type="number" class="quantity-input" id="quantityInput" value="1" min="1">
              <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
            </div>
            <span class="stock-info" id="stockInfo">库存充足</span>
          </div>

          <!-- 操作按钮 -->
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="addToCart()">
              加入购物车
            </button>
            <button class="btn btn-secondary" onclick="buyNow()">
              立即购买
            </button>
            <button class="btn btn-outline btn-favorite" onclick="toggleFavorite()">
              ❤
            </button>
          </div>

          <!-- 商品特点 -->
          <div class="features-list">
            <h3>商品特点</h3>
            <ul id="featuresList">
              <!-- 动态生成 -->
            </ul>
          </div>
        </div>
      </div>

      <!-- 详情选项卡 -->
      <div class="product-tabs">
        <div class="tab-header">
          <button class="tab-btn active" data-tab="detail">商品详情</button>
          <button class="tab-btn" data-tab="specs">规格参数</button>
          <button class="tab-btn" data-tab="reviews">用户评价</button>
        </div>

        <div class="tab-content active" id="tab-detail">
          <div id="detailContent">
            <!-- 动态生成 -->
          </div>
        </div>

        <div class="tab-content" id="tab-specs">
          <table class="specs-table" id="specsTable">
            <!-- 动态生成 -->
          </table>
        </div>

        <div class="tab-content" id="tab-reviews">
          <div class="reviews-summary">
            <div class="reviews-score">
              <div class="score" id="avgRating">5.0</div>
              <div class="stars" id="avgStars">★★★★★</div>
              <div class="count"><span id="totalReviews">0</span>条评价</div>
            </div>
          </div>
          <div id="reviewsList">
            <!-- 动态生成 -->
          </div>
        </div>
      </div>

      <!-- 相关推荐 -->
      <div class="related-products">
        <h2>相关推荐</h2>
        <div class="product-grid grid-4" id="relatedProducts">
          <!-- 动态生成 -->
        </div>
      </div>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div>
          <h3>关于我们</h3>
          <ul>
            <li><a href="#">公司简介</a></li>
            <li><a href="#">联系方式</a></li>
            <li><a href="#">招聘信息</a></li>
            <li><a href="#">新闻中心</a></li>
          </ul>
        </div>
        <div>
          <h3>客户服务</h3>
          <ul>
            <li><a href="#">帮助中心</a></li>
            <li><a href="#">配送方式</a></li>
            <li><a href="#">退换货政策</a></li>
            <li><a href="#">投诉建议</a></li>
          </ul>
        </div>
        <div>
          <h3>商家合作</h3>
          <ul>
            <li><a href="#">入驻条件</a></li>
            <li><a href="#">商家中心</a></li>
            <li><a href="#">营销中心</a></li>
            <li><a href="#">物流服务</a></li>
          </ul>
        </div>
        <div>
          <h3>关注我们</h3>
          <ul>
            <li><a href="#">微信公众号</a></li>
            <li><a href="#">微博</a></li>
            <li><a href="#">抖音</a></li>
            <li><a href="#">小红书</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        © 2024 电商示例 版权所有
      </div>
    </div>
  </footer>

  <script src="/js/common.js"></script>
  <script>
    let currentProduct = null;
    let selectedColor = '';
    let selectedSize = '';

    // 获取商品ID
    function getProductId() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id') || 'SKU001';
    }

    // 初始化
    async function init() {
      const productId = getProductId();
      const products = await Products.load();
      currentProduct = products.find(p => p.id === productId);

      if (!currentProduct) {
        showToast('商品不存在', 'error');
        setTimeout(() => window.location.href = 'products.html', 2000);
        return;
      }

      renderProduct();
      renderTabs();
      renderRelatedProducts(products);
      bindEvents();

      // 推送 view_item 事件
      pushEcommerceEvent('view_item', {
        value: currentProduct.price,
        items: [formatProductItem(currentProduct)]
      });
      
      // Ptengine 商品详情页浏览事件（包含商品属性）
      ptengine.track('商品详情', {
        '事件发生时间戳': Date.now(),
        '事件发生时间': new Date().toLocaleString(),
        '事件发生的url': document.location.href,
        '商品ID': currentProduct.id,
        '商品名称': currentProduct.name,
        '商品价格': currentProduct.price,
        '商品原价': currentProduct.originalPrice || currentProduct.price,
        '商品分类': currentProduct.category,
        '商品品牌': currentProduct.brand || '',
        '商品评分': currentProduct.rating,
        '评价数量': currentProduct.reviewCount,
        '库存数量': currentProduct.stock,
        '是否热卖': currentProduct.isHot ? '是' : '否',
        '是否新品': currentProduct.isNew ? '是' : '否'
      });
    }

    // 渲染商品信息
    function renderProduct() {
      const p = currentProduct;

      // 更新页面标题
      document.title = `${p.name} - 电商示例`;

      // 面包屑
      document.getElementById('categoryLink').textContent = p.category;
      document.getElementById('categoryLink').href = `products.html?category=${p.category}`;
      document.getElementById('productName').textContent = p.name;

      // 主图
      document.getElementById('mainImage').src = p.images?.[0] || p.image;
      document.getElementById('mainImage').alt = p.name;

      // 缩略图
      const images = p.images || [p.image];
      document.getElementById('thumbnailList').innerHTML = images.map((img, i) => `
        <div class="thumbnail ${i === 0 ? 'active' : ''}" onclick="changeImage(${i}, '${img}')">
          <img src="${img}" alt="${p.name}">
        </div>
      `).join('');

      // 基本信息
      document.getElementById('productTitle').textContent = p.name;
      document.getElementById('ratingStars').textContent = generateStars(p.rating);
      document.getElementById('ratingScore').textContent = p.rating.toFixed(1);
      document.getElementById('reviewCount').textContent = p.reviewCount;
      document.getElementById('salesCount').textContent = Math.floor(p.reviewCount * 2.5);

      // 价格
      document.getElementById('currentPrice').textContent = formatPrice(p.price);
      if (p.originalPrice) {
        document.getElementById('originalPrice').textContent = formatPrice(p.originalPrice);
        const discount = Math.round((1 - p.price / p.originalPrice) * 100);
        document.getElementById('discountTag').textContent = `-${discount}%`;
        document.getElementById('discountTag').style.display = 'inline-block';
      }

      // 描述
      document.getElementById('productDesc').textContent = p.description;

      // 颜色选项
      if (p.colors && p.colors.length > 0) {
        document.getElementById('colorSection').style.display = 'block';
        selectedColor = p.colors[0];
        document.getElementById('selectedColor').textContent = selectedColor;
        document.getElementById('colorOptions').innerHTML = p.colors.map((color, i) => `
          <div class="option-item ${i === 0 ? 'active' : ''}" onclick="selectColor('${color}', this)">
            ${color}
          </div>
        `).join('');
      }

      // 尺码选项
      if (p.sizes && p.sizes.length > 0) {
        document.getElementById('sizeSection').style.display = 'block';
        selectedSize = p.sizes[0];
        document.getElementById('selectedSize').textContent = selectedSize;
        document.getElementById('sizeOptions').innerHTML = p.sizes.map((size, i) => `
          <div class="option-item ${i === 0 ? 'active' : ''}" onclick="selectSize('${size}', this)">
            ${size}
          </div>
        `).join('');
      }

      // 库存
      const stockInfo = document.getElementById('stockInfo');
      if (p.stock < 10) {
        stockInfo.textContent = `仅剩 ${p.stock} 件`;
        stockInfo.classList.add('low');
      } else {
        stockInfo.textContent = `库存充足`;
      }

      // 特点
      if (p.features) {
        document.getElementById('featuresList').innerHTML = p.features.map(f => `
          <li>${f}</li>
        `).join('');
      }
    }

    // 渲染选项卡内容
    function renderTabs() {
      const p = currentProduct;

      // 商品详情
      document.getElementById('detailContent').innerHTML = `
        <p style="margin-bottom: 20px; line-height: 1.8;">${p.description}</p>
        ${p.features ? `
          <h3 style="margin: 20px 0 15px;">产品特点</h3>
          <ul style="line-height: 2;">
            ${p.features.map(f => `<li style="margin-bottom: 8px;">• ${f}</li>`).join('')}
          </ul>
        ` : ''}
        <div style="margin-top: 30px; text-align: center;">
          <img src="${p.images?.[0] || p.image}" alt="${p.name}" style="max-width: 100%; border-radius: 8px;">
        </div>
      `;

      // 规格参数
      if (p.specs) {
        document.getElementById('specsTable').innerHTML = Object.entries(p.specs).map(([key, value]) => `
          <tr>
            <th>${key}</th>
            <td>${value}</td>
          </tr>
        `).join('');
      }

      // 评价
      document.getElementById('avgRating').textContent = p.rating.toFixed(1);
      document.getElementById('avgStars').textContent = generateStars(p.rating);
      document.getElementById('totalReviews').textContent = p.reviewCount;

      // 模拟评价数据
      const reviews = [
        { author: '王先生', date: '2024-05-15', rating: 5, content: '非常满意这次购买，商品质量很好，物流也很快。' },
        { author: '李女士', date: '2024-05-10', rating: 4, content: '整体不错，性价比很高，推荐购买。' },
        { author: '张先生', date: '2024-05-05', rating: 5, content: '用了一段时间了，确实很好用，会回购的！' }
      ];

      document.getElementById('reviewsList').innerHTML = reviews.map(r => `
        <div class="review-item">
          <div class="review-header">
            <span class="review-author">${r.author}</span>
            <span class="review-date">${r.date}</span>
          </div>
          <div class="review-rating">${generateStars(r.rating)}</div>
          <p class="review-content">${r.content}</p>
        </div>
      `).join('');
    }

    // 渲染相关推荐
    function renderRelatedProducts(products) {
      const related = products
        .filter(p => p.category === currentProduct.category && p.id !== currentProduct.id)
        .slice(0, 4);

      document.getElementById('relatedProducts').innerHTML = related.map(p => `
        <div class="product-card" onclick="window.location.href='product-detail.html?id=${p.id}'">
          <div class="product-image">
            <img src="${p.image}" alt="${p.name}" loading="lazy">
          </div>
          <div class="product-info">
            <h3 class="product-title">${p.name}</h3>
            <div class="product-price">${formatPrice(p.price)}</div>
          </div>
        </div>
      `).join('');
    }

    // 绑定事件
    function bindEvents() {
      // 选项卡切换
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
        });
      });

      // 数量输入
      document.getElementById('quantityInput').addEventListener('change', (e) => {
        let value = parseInt(e.target.value) || 1;
        value = Math.max(1, Math.min(value, currentProduct.stock));
        e.target.value = value;
      });
    }

    // 切换主图
    function changeImage(index, src) {
      document.getElementById('mainImage').src = src;
      document.querySelectorAll('.thumbnail').forEach((t, i) => {
        t.classList.toggle('active', i === index);
      });
    }

    // 选择颜色
    function selectColor(color, el) {
      selectedColor = color;
      document.getElementById('selectedColor').textContent = color;
      document.querySelectorAll('#colorOptions .option-item').forEach(item => {
        item.classList.remove('active');
      });
      el.classList.add('active');
    }

    // 选择尺码
    function selectSize(size, el) {
      selectedSize = size;
      document.getElementById('selectedSize').textContent = size;
      document.querySelectorAll('#sizeOptions .option-item').forEach(item => {
        item.classList.remove('active');
      });
      el.classList.add('active');
    }

    // 修改数量
    function changeQuantity(delta) {
      const input = document.getElementById('quantityInput');
      let value = parseInt(input.value) || 1;
      value = Math.max(1, Math.min(value + delta, currentProduct.stock));
      input.value = value;
    }

    // 加入购物车
    function addToCart() {
      const quantity = parseInt(document.getElementById('quantityInput').value) || 1;
      const variant = {};
      
      if (selectedColor) variant.color = selectedColor;
      if (selectedSize) variant.size = selectedSize;

      Cart.addItem(currentProduct, quantity, variant);
      
      // Ptengine 事件追踪
      ptengine.track('加入购物车', {
        '事件发生时间戳': Date.now(),
        '事件发生时间': new Date().toLocaleString(),
        '事件发生的url': document.location.href,
        '商品ID': currentProduct.id,
        '商品名称': currentProduct.name,
        '商品价格': currentProduct.price,
        '购买数量': quantity,
        '颜色': selectedColor || '',
        '尺码': selectedSize || ''
      });
    }

    // 立即购买
    function buyNow() {
      const quantity = parseInt(document.getElementById('quantityInput').value) || 1;
      
      // Ptengine 事件追踪
      ptengine.track('立即购买', {
        '事件发生时间戳': Date.now(),
        '事件发生时间': new Date().toLocaleString(),
        '事件发生的url': document.location.href,
        '商品ID': currentProduct.id,
        '商品名称': currentProduct.name,
        '商品价格': currentProduct.price,
        '购买数量': quantity
      });
      
      addToCart();
      window.location.href = 'cart.html';
    }

    // 收藏
    function toggleFavorite() {
      // Ptengine 事件追踪
      ptengine.track('收藏商品', {
        '事件发生时间戳': Date.now(),
        '事件发生时间': new Date().toLocaleString(),
        '事件发生的url': document.location.href,
        '商品ID': currentProduct.id,
        '商品名称': currentProduct.name,
        '商品价格': currentProduct.price
      });
      
      showToast('已添加到收藏夹');
    }

    // 初始化
    init();
  </script>
</body>
</html>
