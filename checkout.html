<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-TTPBR7L');</script>
  <!-- End Google Tag Manager -->
  <script src="https://cdn.amplitude.com/script/92be23a58f32a14b496d02c34c2cc0f5.js"></script>
  <script>window.amplitude.add(window.sessionReplay.plugin({sampleRate: 1}));window.amplitude.init('92be23a58f32a14b496d02c34c2cc0f5', {"fetchRemoteConfig":true,"autocapture":{"attribution":true,"fileDownloads":true,"formInteractions":true,"pageViews":true,"sessions":true,"elementInteractions":true,"networkTracking":true,"webVitals":true,"frustrationInteractions":true}});</script>
  <script src="https://devjs.ptengine.com/7a80pnx3.js"></script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="å®Œæˆæ‚¨çš„è®¢å•">
  <title>ç»“ç®— - ç”µå•†ç¤ºä¾‹</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/common.css">
  <style>
    .checkout-page {
      padding: 40px 0 60px;
    }

    .checkout-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 30px;
      align-items: start;
    }

    /* ç»“ç®—è¡¨å• */
    .checkout-form {
      background-color: var(--bg-white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .form-section {
      padding: 30px;
      border-bottom: 1px solid var(--border-light);
    }

    .form-section:last-child {
      border-bottom: none;
    }

    .section-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title .icon {
      width: 30px;
      height: 30px;
      background-color: var(--primary-color);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    /* é…é€æ–¹å¼ */
    .shipping-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .shipping-option {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
    }

    .shipping-option:hover {
      border-color: var(--primary-color);
    }

    .shipping-option.active {
      border-color: var(--primary-color);
      background-color: rgba(255, 107, 107, 0.05);
    }

    .shipping-option input {
      margin-right: 15px;
      accent-color: var(--primary-color);
    }

    .shipping-info {
      flex: 1;
    }

    .shipping-name {
      font-weight: 500;
      margin-bottom: 5px;
    }

    .shipping-desc {
      font-size: 13px;
      color: var(--text-muted);
    }

    .shipping-price {
      font-weight: bold;
      color: var(--primary-color);
    }

    /* æ”¯ä»˜æ–¹å¼ */
    .payment-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .payment-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
    }

    .payment-option:hover {
      border-color: var(--primary-color);
    }

    .payment-option.active {
      border-color: var(--primary-color);
      background-color: rgba(255, 107, 107, 0.05);
    }

    .payment-option input {
      display: none;
    }

    .payment-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .payment-name {
      font-weight: 500;
    }

    /* è®¢å•æ‘˜è¦ */
    .order-summary {
      background-color: var(--bg-white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky;
      top: 90px;
    }

    .summary-header {
      padding: 20px 25px;
      border-bottom: 1px solid var(--border-light);
    }

    .summary-header h2 {
      font-size: 18px;
    }

    .summary-items {
      padding: 20px 25px;
      max-height: 300px;
      overflow-y: auto;
    }

    .summary-item {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-light);
    }

    .summary-item:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .summary-item-image {
      width: 60px;
      height: 60px;
      border-radius: var(--radius-sm);
      overflow: hidden;
      flex-shrink: 0;
    }

    .summary-item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .summary-item-info {
      flex: 1;
      min-width: 0;
    }

    .summary-item-name {
      font-size: 14px;
      margin-bottom: 5px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .summary-item-variant {
      font-size: 12px;
      color: var(--text-muted);
    }

    .summary-item-price {
      text-align: right;
    }

    .summary-item-price .price {
      font-weight: 500;
      color: var(--primary-color);
    }

    .summary-item-price .quantity {
      font-size: 12px;
      color: var(--text-muted);
    }

    .summary-totals {
      padding: 20px 25px;
      border-top: 1px solid var(--border-light);
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .summary-row .label {
      color: var(--text-light);
    }

    .summary-row.total {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border-light);
      font-size: 16px;
      margin-bottom: 0;
    }

    .summary-row.total .value {
      font-size: 24px;
      color: var(--primary-color);
      font-weight: bold;
    }

    .summary-actions {
      padding: 20px 25px;
      border-top: 1px solid var(--border-light);
    }

    .place-order-btn {
      width: 100%;
      padding: 15px;
      font-size: 16px;
    }

    .terms-check {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-top: 15px;
      font-size: 13px;
      color: var(--text-light);
    }

    .terms-check input {
      margin-top: 3px;
      accent-color: var(--primary-color);
    }

    .terms-check a {
      color: var(--primary-color);
    }

    /* å®‰å…¨æç¤º */
    .security-notice {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 15px;
      background-color: var(--bg-color);
      border-radius: 0 0 var(--radius) var(--radius);
      font-size: 13px;
      color: var(--text-muted);
    }

    .security-notice .icon {
      color: var(--success-color);
    }

    @media (max-width: 992px) {
      .checkout-layout {
        grid-template-columns: 1fr;
      }

      .order-summary {
        position: static;
        order: -1;
      }

      .payment-options {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TTPBR7L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  <script>
    ptengine.track('ç»“ç®—',{'äº‹ä»¶å‘ç”Ÿæ—¶é—´æˆ³':Date.now(),'äº‹ä»¶å‘ç”Ÿæ—¶é—´':new Date().toLocaleString(),'äº‹ä»¶å‘ç”Ÿçš„url':document.location.href});
  </script>

  <!-- å¤´éƒ¨å¯¼èˆª -->
  <header class="header">
    <div class="container">
      <div class="header-content">
        <a href="index.html" class="logo">ç”µå•†ç¤ºä¾‹</a>
        <button class="menu-toggle" aria-label="èœå•">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <nav class="nav">
          <a href="index.html">é¦–é¡µ</a>
          <a href="products.html">å…¨éƒ¨å•†å“</a>
          <a href="cart.html" class="cart-icon">
            è´­ç‰©è½¦
            <span class="cart-count" style="display: none;">0</span>
          </a>
          <a href="account.html">æˆ‘çš„è´¦æˆ·</a>
        </nav>
      </div>
    </div>
  </header>

  <main class="checkout-page">
    <div class="container">
      <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
      <div class="steps">
        <div class="step completed">
          <div class="step-number">âœ“</div>
          <div class="step-label">è´­ç‰©è½¦</div>
        </div>
        <div class="step active">
          <div class="step-number">2</div>
          <div class="step-label">ç»“ç®—</div>
        </div>
        <div class="step">
          <div class="step-number">3</div>
          <div class="step-label">å®Œæˆ</div>
        </div>
      </div>

      <div class="checkout-layout">
        <!-- ç»“ç®—è¡¨å• -->
        <div class="checkout-form">
          <!-- æ”¶è´§ä¿¡æ¯ -->
          <div class="form-section">
            <h2 class="section-title">
              <span class="icon">1</span>
              æ”¶è´§ä¿¡æ¯
            </h2>
            <div class="form-row">
              <div class="form-group">
                <label>æ”¶è´§äºº <span class="required">*</span></label>
                <input type="text" class="form-control" id="name" placeholder="è¯·è¾“å…¥æ”¶è´§äººå§“å" required>
              </div>
              <div class="form-group">
                <label>æ‰‹æœºå·ç  <span class="required">*</span></label>
                <input type="tel" class="form-control" id="phone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç " required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>çœä»½ <span class="required">*</span></label>
                <select class="form-control" id="province" required>
                  <option value="">è¯·é€‰æ‹©çœä»½</option>
                  <option value="åŒ—äº¬å¸‚">åŒ—äº¬å¸‚</option>
                  <option value="ä¸Šæµ·å¸‚">ä¸Šæµ·å¸‚</option>
                  <option value="å¹¿ä¸œçœ">å¹¿ä¸œçœ</option>
                  <option value="æ±Ÿè‹çœ">æ±Ÿè‹çœ</option>
                  <option value="æµ™æ±Ÿçœ">æµ™æ±Ÿçœ</option>
                  <option value="å››å·çœ">å››å·çœ</option>
                </select>
              </div>
              <div class="form-group">
                <label>åŸå¸‚ <span class="required">*</span></label>
                <input type="text" class="form-control" id="city" placeholder="è¯·è¾“å…¥åŸå¸‚" required>
              </div>
            </div>
            <div class="form-group">
              <label>è¯¦ç»†åœ°å€ <span class="required">*</span></label>
              <input type="text" class="form-control" id="address" placeholder="è¯·è¾“å…¥è¯¦ç»†åœ°å€ï¼ˆè¡—é“ã€é—¨ç‰Œå·ç­‰ï¼‰" required>
            </div>
            <div class="form-group">
              <label>é‚®æ”¿ç¼–ç </label>
              <input type="text" class="form-control" id="zipcode" placeholder="è¯·è¾“å…¥é‚®æ”¿ç¼–ç ">
            </div>
          </div>

          <!-- é…é€æ–¹å¼ -->
          <div class="form-section">
            <h2 class="section-title">
              <span class="icon">2</span>
              é…é€æ–¹å¼
            </h2>
            <div class="shipping-options">
              <label class="shipping-option active" data-shipping="standard" data-price="0">
                <input type="radio" name="shipping" value="standard" checked>
                <div class="shipping-info">
                  <div class="shipping-name">æ ‡å‡†é…é€</div>
                  <div class="shipping-desc">é¢„è®¡ 3-5 ä¸ªå·¥ä½œæ—¥é€è¾¾</div>
                </div>
                <div class="shipping-price">å…è´¹</div>
              </label>
              <label class="shipping-option" data-shipping="express" data-price="15">
                <input type="radio" name="shipping" value="express">
                <div class="shipping-info">
                  <div class="shipping-name">å¿«é€Ÿé…é€</div>
                  <div class="shipping-desc">é¢„è®¡ 1-2 ä¸ªå·¥ä½œæ—¥é€è¾¾</div>
                </div>
                <div class="shipping-price">Â¥15.00</div>
              </label>
              <label class="shipping-option" data-shipping="sameday" data-price="30">
                <input type="radio" name="shipping" value="sameday">
                <div class="shipping-info">
                  <div class="shipping-name">å½“æ—¥è¾¾</div>
                  <div class="shipping-desc">é™éƒ¨åˆ†åŸå¸‚ï¼Œå½“æ—¥ 18:00 å‰ä¸‹å•</div>
                </div>
                <div class="shipping-price">Â¥30.00</div>
              </label>
            </div>
          </div>

          <!-- æ”¯ä»˜æ–¹å¼ -->
          <div class="form-section">
            <h2 class="section-title">
              <span class="icon">3</span>
              æ”¯ä»˜æ–¹å¼
            </h2>
            <div class="payment-options">
              <label class="payment-option active" data-payment="alipay">
                <input type="radio" name="payment" value="alipay" checked>
                <div class="payment-icon">ğŸ’³</div>
                <div class="payment-name">æ”¯ä»˜å®</div>
              </label>
              <label class="payment-option" data-payment="wechat">
                <input type="radio" name="payment" value="wechat">
                <div class="payment-icon">ğŸ’š</div>
                <div class="payment-name">å¾®ä¿¡æ”¯ä»˜</div>
              </label>
              <label class="payment-option" data-payment="unionpay">
                <input type="radio" name="payment" value="unionpay">
                <div class="payment-icon">ğŸ¦</div>
                <div class="payment-name">é“¶è”æ”¯ä»˜</div>
              </label>
              <label class="payment-option" data-payment="credit">
                <input type="radio" name="payment" value="credit">
                <div class="payment-icon">ğŸ’³</div>
                <div class="payment-name">ä¿¡ç”¨å¡</div>
              </label>
            </div>
          </div>

          <!-- å¤‡æ³¨ -->
          <div class="form-section">
            <h2 class="section-title">
              <span class="icon">4</span>
              è®¢å•å¤‡æ³¨
            </h2>
            <div class="form-group">
              <textarea class="form-control" id="notes" rows="3" placeholder="å¦‚æœ‰ç‰¹æ®Šè¦æ±‚è¯·åœ¨æ­¤å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰"></textarea>
            </div>
          </div>
        </div>

        <!-- è®¢å•æ‘˜è¦ -->
        <div class="order-summary">
          <div class="summary-header">
            <h2>è®¢å•æ‘˜è¦</h2>
          </div>
          
          <div class="summary-items" id="summaryItems">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
          </div>

          <div class="summary-totals">
            <div class="summary-row">
              <span class="label">å•†å“æ€»ä»·</span>
              <span class="value" id="subtotal">Â¥0.00</span>
            </div>
            <div class="summary-row">
              <span class="label">è¿è´¹</span>
              <span class="value" id="shippingCost">Â¥0.00</span>
            </div>
            <div class="summary-row total">
              <span class="label">åº”ä»˜æ€»é¢</span>
              <span class="value" id="totalAmount">Â¥0.00</span>
            </div>
          </div>

          <div class="summary-actions">
            <button class="btn btn-primary place-order-btn" onclick="placeOrder()">
              æäº¤è®¢å•
            </button>
            <label class="terms-check">
              <input type="checkbox" id="agreeTerms" checked>
              <span>æˆ‘å·²é˜…è¯»å¹¶åŒæ„ <a href="#">æœåŠ¡æ¡æ¬¾</a> å’Œ <a href="#">éšç§æ”¿ç­–</a></span>
            </label>
          </div>

          <div class="security-notice">
            <span class="icon">ğŸ”’</span>
            <span>æ‚¨çš„æ”¯ä»˜ä¿¡æ¯å°†è¢«å®‰å…¨åŠ å¯†</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- é¡µè„š -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div>
          <h3>å…³äºæˆ‘ä»¬</h3>
          <ul>
            <li><a href="#">å…¬å¸ç®€ä»‹</a></li>
            <li><a href="#">è”ç³»æ–¹å¼</a></li>
            <li><a href="#">æ‹›è˜ä¿¡æ¯</a></li>
            <li><a href="#">æ–°é—»ä¸­å¿ƒ</a></li>
          </ul>
        </div>
        <div>
          <h3>å®¢æˆ·æœåŠ¡</h3>
          <ul>
            <li><a href="#">å¸®åŠ©ä¸­å¿ƒ</a></li>
            <li><a href="#">é…é€æ–¹å¼</a></li>
            <li><a href="#">é€€æ¢è´§æ”¿ç­–</a></li>
            <li><a href="#">æŠ•è¯‰å»ºè®®</a></li>
          </ul>
        </div>
        <div>
          <h3>å•†å®¶åˆä½œ</h3>
          <ul>
            <li><a href="#">å…¥é©»æ¡ä»¶</a></li>
            <li><a href="#">å•†å®¶ä¸­å¿ƒ</a></li>
            <li><a href="#">è¥é”€ä¸­å¿ƒ</a></li>
            <li><a href="#">ç‰©æµæœåŠ¡</a></li>
          </ul>
        </div>
        <div>
          <h3>å…³æ³¨æˆ‘ä»¬</h3>
          <ul>
            <li><a href="#">å¾®ä¿¡å…¬ä¼—å·</a></li>
            <li><a href="#">å¾®åš</a></li>
            <li><a href="#">æŠ–éŸ³</a></li>
            <li><a href="#">å°çº¢ä¹¦</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        Â© 2024 ç”µå•†ç¤ºä¾‹ ç‰ˆæƒæ‰€æœ‰
      </div>
    </div>
  </footer>

  <script src="/js/common.js"></script>
  <script>
    let checkoutItems = [];
    let subtotal = 0;
    let shippingCost = 0;

    // åˆå§‹åŒ–
    function init() {
      // ä» sessionStorage è·å–ç»“ç®—å•†å“
      const stored = sessionStorage.getItem('checkoutItems');
      if (stored) {
        checkoutItems = JSON.parse(stored);
      } else {
        // å¦‚æœæ²¡æœ‰ï¼Œä½¿ç”¨è´­ç‰©è½¦å…¨éƒ¨å•†å“
        checkoutItems = Cart.getItems();
      }

      if (checkoutItems.length === 0) {
        showToast('è´­ç‰©è½¦ä¸ºç©º', 'error');
        setTimeout(() => window.location.href = 'cart.html', 1500);
        return;
      }

      renderSummaryItems();
      updateTotals();
      bindEvents();

      // æ¨é€ begin_checkout äº‹ä»¶
      pushEcommerceEvent('begin_checkout', {
        value: subtotal,
        items: checkoutItems.map((item, i) => ({
          item_id: item.id,
          item_name: item.name,
          price: item.price,
          quantity: item.quantity,
          index: i
        }))
      });
    }

    // æ¸²æŸ“è®¢å•å•†å“
    function renderSummaryItems() {
      const container = document.getElementById('summaryItems');
      
      container.innerHTML = checkoutItems.map(item => {
        const variantText = item.variant ? 
          Object.entries(item.variant).map(([k, v]) => v).join(' / ') : '';
        
        return `
          <div class="summary-item">
            <div class="summary-item-image">
              <img src="${item.image}" alt="${item.name}">
            </div>
            <div class="summary-item-info">
              <div class="summary-item-name">${item.name}</div>
              ${variantText ? `<div class="summary-item-variant">${variantText}</div>` : ''}
            </div>
            <div class="summary-item-price">
              <div class="price">${formatPrice(item.price * item.quantity)}</div>
              <div class="quantity">x${item.quantity}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
      // é…é€æ–¹å¼é€‰æ‹©
      document.querySelectorAll('.shipping-option').forEach(option => {
        option.addEventListener('click', () => {
          document.querySelectorAll('.shipping-option').forEach(o => o.classList.remove('active'));
          option.classList.add('active');
          option.querySelector('input').checked = true;
          shippingCost = parseFloat(option.dataset.price) || 0;
          updateTotals();
        });
      });

      // æ”¯ä»˜æ–¹å¼é€‰æ‹©
      document.querySelectorAll('.payment-option').forEach(option => {
        option.addEventListener('click', () => {
          document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('active'));
          option.classList.add('active');
          option.querySelector('input').checked = true;
        });
      });
    }

    // æ›´æ–°æ€»è®¡
    function updateTotals() {
      subtotal = checkoutItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
      const total = subtotal + shippingCost;

      document.getElementById('subtotal').textContent = formatPrice(subtotal);
      document.getElementById('shippingCost').textContent = shippingCost === 0 ? 'å…è´¹' : formatPrice(shippingCost);
      document.getElementById('totalAmount').textContent = formatPrice(total);
    }

    // è¡¨å•éªŒè¯
    function validateForm() {
      const required = ['name', 'phone', 'province', 'city', 'address'];
      
      for (const field of required) {
        const input = document.getElementById(field);
        if (!input.value.trim()) {
          showToast(`è¯·å¡«å†™${input.previousElementSibling.textContent.replace(' *', '')}`, 'error');
          input.focus();
          return false;
        }
      }

      // æ‰‹æœºå·éªŒè¯
      const phone = document.getElementById('phone').value;
      if (!/^1[3-9]\d{9}$/.test(phone)) {
        showToast('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ', 'error');
        document.getElementById('phone').focus();
        return false;
      }

      // åŒæ„æ¡æ¬¾
      if (!document.getElementById('agreeTerms').checked) {
        showToast('è¯·é˜…è¯»å¹¶åŒæ„æœåŠ¡æ¡æ¬¾', 'error');
        return false;
      }

      return true;
    }

    // æäº¤è®¢å•
    function placeOrder() {
      if (!validateForm()) return;

      const orderId = generateOrderId();
      const total = subtotal + shippingCost;
      
      // Ptengine äº‹ä»¶è¿½è¸ª - æäº¤è®¢å•
      ptengine.track('æäº¤è®¢å•', {
        'äº‹ä»¶å‘ç”Ÿæ—¶é—´æˆ³': Date.now(),
        'äº‹ä»¶å‘ç”Ÿæ—¶é—´': new Date().toLocaleString(),
        'äº‹ä»¶å‘ç”Ÿçš„url': document.location.href,
        'è®¢å•å·': orderId,
        'å•†å“æ€»é¢': subtotal,
        'è¿è´¹': shippingCost,
        'è®¢å•æ€»é¢': total,
        'å•†å“æ•°é‡': checkoutItems.reduce((sum, item) => sum + item.quantity, 0),
        'æ”¯ä»˜æ–¹å¼': document.querySelector('input[name="payment"]:checked').value,
        'é…é€æ–¹å¼': document.querySelector('input[name="shipping"]:checked').value
      });

      // æ”¶é›†è®¢å•ä¿¡æ¯
      const orderInfo = {
        orderId: orderId,
        items: checkoutItems,
        shipping: {
          name: document.getElementById('name').value,
          phone: document.getElementById('phone').value,
          province: document.getElementById('province').value,
          city: document.getElementById('city').value,
          address: document.getElementById('address').value,
          zipcode: document.getElementById('zipcode').value,
          method: document.querySelector('input[name="shipping"]:checked').value
        },
        payment: document.querySelector('input[name="payment"]:checked').value,
        notes: document.getElementById('notes').value,
        subtotal: subtotal,
        shippingCost: shippingCost,
        total: total,
        createdAt: new Date().toISOString()
      };

      // ä¿å­˜è®¢å•ä¿¡æ¯
      sessionStorage.setItem('lastOrder', JSON.stringify(orderInfo));

      // æ¨é€ purchase äº‹ä»¶
      pushEcommerceEvent('purchase', {
        transaction_id: orderId,
        value: total,
        shipping: shippingCost,
        items: checkoutItems.map((item, i) => ({
          item_id: item.id,
          item_name: item.name,
          price: item.price,
          quantity: item.quantity,
          index: i
        }))
      });
      
      // Ptengine äº‹ä»¶è¿½è¸ª - è´­ä¹°å®Œæˆ
      ptengine.track('è´­ä¹°å®Œæˆ', {
        'äº‹ä»¶å‘ç”Ÿæ—¶é—´æˆ³': Date.now(),
        'äº‹ä»¶å‘ç”Ÿæ—¶é—´': new Date().toLocaleString(),
        'äº‹ä»¶å‘ç”Ÿçš„url': document.location.href,
        'è®¢å•å·': orderId,
        'è®¢å•æ€»é¢': total,
        'å•†å“æ•°é‡': checkoutItems.reduce((sum, item) => sum + item.quantity, 0)
      });

      // æ¸…ç©ºè´­ç‰©è½¦ä¸­å·²è´­ä¹°çš„å•†å“
      const cartItems = Cart.getItems();
      const remainingItems = cartItems.filter(cartItem => 
        !checkoutItems.some(checkoutItem => 
          checkoutItem.id === cartItem.id && 
          JSON.stringify(checkoutItem.variant) === JSON.stringify(cartItem.variant)
        )
      );
      Cart.saveItems(remainingItems);

      // æ¸…é™¤ç»“ç®—æ•°æ®
      sessionStorage.removeItem('checkoutItems');

      // è·³è½¬åˆ°è®¢å•æˆåŠŸé¡µ
      window.location.href = 'order-success.html';
    }

    // åˆå§‹åŒ–
    init();
  </script>
</body>
</html>
